{% extends "base.html" %}

{% block title %}Stats - {{ domain }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-graph-up"></i> Email Statistics
        </h1>
        
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-envelope-fill fs-1"></i>
                        <h3 class="card-title">{{ stats.total_emails }}</h3>
                        <p class="card-text">Total Emails</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-person-fill fs-1"></i>
                        <h3 class="card-title">{{ stats.unique_senders }}</h3>
                        <p class="card-text">Unique Senders</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-people-fill fs-1"></i>
                        <h3 class="card-title">{{ stats.unique_receivers }}</h3>
                        <p class="card-text">Unique Receivers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <i class="bi bi-trash-fill fs-1"></i>
                        <h3 class="card-title">{{ stats.deleted_count }}</h3>
                        <p class="card-text">Deleted Emails</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Age Distribution -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar"></i> Email Age Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Recent (0-7 days)</span>
                                <span class="badge bg-success">{{ stats.recent_emails }}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" style="width: {{ (stats.recent_emails / stats.total_emails * 100) if stats.total_emails > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Older (8-30 days)</span>
                                <span class="badge bg-warning">{{ stats.older_emails }}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning" style="width: {{ (stats.older_emails / stats.total_emails * 100) if stats.total_emails > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Very Old (30+ days)</span>
                                <span class="badge bg-danger">{{ stats.very_old_emails }}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-danger" style="width: {{ (stats.very_old_emails / stats.total_emails * 100) if stats.total_emails > 0 else 0 }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-hdd"></i> Storage Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Total Size</span>
                                <span class="badge bg-primary">{{ stats.total_size_mb }} MB</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Average Email Size</span>
                                <span class="badge bg-info">{{ stats.avg_size_kb }} KB</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Largest Email</span>
                                <span class="badge bg-warning">{{ stats.largest_email_kb }} KB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Emails Table -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Recent Emails</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>From</th>
                                <th>To</th>
                                <th>Subject</th>
                                <th>Age (days)</th>
                                <th>Size</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email in stats.recent_emails_list %}
                            <tr>
                                <td>
                                    <small class="text-muted">{{ email.from_[:30] }}{% if email.from_|length > 30 %}...{% endif %}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ email.to_[:30] }}{% if email.to_|length > 30 %}...{% endif %}</small>
                                </td>
                                <td>
                                    <small>{{ email.subject[:40] }}{% if email.subject|length > 40 %}...{% endif %}</small>
                                </td>
                                <td>
                                    {% if email.age_days == 'N/A' %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% elif email.age_days <= 7 %}
                                        <span class="badge bg-success">{{ email.age_days }}</span>
                                    {% elif email.age_days <= 30 %}
                                        <span class="badge bg-warning">{{ email.age_days }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ email.age_days }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ email.size_kb }} KB</small>
                                </td>
                                <td>
                                    {% if email.status == 'Kept' %}
                                        <span class="badge bg-success">Kept</span>
                                    {% elif email.status == 'Deleted' %}
                                        <span class="badge bg-danger">Deleted</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ email.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Senders -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-person-fill"></i> Top Senders</h5>
                    </div>
                    <div class="card-body">
                        {% for sender in stats.top_senders %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">{{ sender.email[:25] }}{% if sender.email|length > 25 %}...{% endif %}</small>
                            <span class="badge bg-primary">{{ sender.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-people-fill"></i> Top Receivers</h5>
                    </div>
                    <div class="card-body">
                        {% for receiver in stats.top_receivers %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">{{ receiver.email[:25] }}{% if receiver.email|length > 25 %}...{% endif %}</small>
                            <span class="badge bg-info">{{ receiver.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}
